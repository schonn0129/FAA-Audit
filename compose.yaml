# FAA Audit Application - Synology NAS Deployment
#
# Location on NAS: /volume1/audit-app/compose.yaml
# Code layout:     /volume1/audit-app/backend/  and  /volume1/audit-app/frontend/
# Persistent data: /volume1/audit-app/data/  (db, uploads, manuals â€” never overwritten by deploy)
#
# Container Manager will build both images on first run.
# First build takes 5-10 minutes (downloads PyTorch for embeddings).

version: "3.9"

services:
  # Python Flask Backend API
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: faa-audit-backend
    restart: unless-stopped
    volumes:
      # Persistent data storage (outside the build context)
      - ./data/uploads:/app/uploads
      - ./data/manuals:/app/manuals
      - ./data/db:/app/data
    environment:
      - FLASK_ENV=production
      - EMBEDDING_ENABLED=true
      - DATABASE_PATH=/app/data/faa_audit.db
      - UPLOAD_FOLDER=/app/uploads
      - MANUALS_FOLDER=/app/manuals
    networks:
      - faa-network
    # Backend is NOT exposed externally - only accessible via frontend proxy

  # React Frontend served by nginx
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: faa-audit-frontend
    restart: unless-stopped
    ports:
      - "8888:80"
    depends_on:
      - backend
    networks:
      - faa-network

networks:
  faa-network:
    driver: bridge
